{"version":3,"sources":["methods.js"],"names":[],"mappings":"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","file":"methods-compiled.js","sourcesContent":["import _ from 'underscore';\nimport { Meteor } from 'meteor/meteor';\nimport { check } from 'meteor/check';\nimport { Email } from 'meteor/email';\n\nimport { Parties } from './collection';\n\nfunction getContactEmail(user) {\n    if (user.emails && user.emails.length)\n        return user.emails[0].address;\n\n    if (user.services && user.services.facebook && user.services.facebook.email)\n        return user.services.facebook.email;\n\n    return null;\n}\n\nexport function invite(fcListId, userId) {\n    check(fcListId, String);\n    check(userId, String);\n\n    if (!this.userId) {\n        throw new Meteor.Error(400, 'You have to be logged in!');\n    }\n\n    const fcList = Parties.findOne(fcListId);\n\n    if (!fcList) {\n        throw new Meteor.Error(404, 'No such fcList!');\n    }\n\n    if (fcList.owner !== this.userId) {\n        throw new Meteor.Error(404, 'No permissions!');\n    }\n\n    if (fcList.public) {\n        throw new Meteor.Error(400, 'That fcList is public. No need to invite people.');\n    }\n\n    if (userId !== fcList.owner && ! _.contains(fcList.invited, userId)) {\n        Parties.update(fcListId, {\n            $addToSet: {\n                invited: userId\n            }\n        });\n\n        const replyTo = getContactEmail(Meteor.users.findOne(this.userId));\n        const to = getContactEmail(Meteor.users.findOne(userId));\n\n        if (Meteor.isServer && to) {\n            Email.send({\n                to,\n                replyTo,\n                from: 'noreply@socially.com',\n                subject: `PARTY: ${fcList.title}`,\n                text: `\n          Hey, I just invited you to ${fcList.title} on Socially.\n          Come check it out: ${Meteor.absoluteUrl()}\n        `\n            });\n        }\n    }\n}\nexport function rsvp(fcListId, rsvp) {\n    check(fcListId, String);\n    check(rsvp, String);\n\n    if (!this.userId) {\n        throw new Meteor.Error(403, 'You must be logged in to RSVP');\n    }\n\n    if (!_.contains(['yes', 'no', 'maybe'], rsvp)) {\n        throw new Meteor.Error(400, 'Invalid RSVP');\n    }\n\n    const fcList = Parties.findOne({\n        _id: fcListId,\n        $or: [{\n            // is public\n            $and: [{\n                public: true\n            }, {\n                public: {\n                    $exists: true\n                }\n            }]\n        },{\n            // is owner\n            $and: [{\n                owner: this.userId\n            }, {\n                owner: {\n                    $exists: true\n                }\n            }]\n        }, {\n            // is invited\n            $and: [{\n                invited: this.userId\n            }, {\n                invited: {\n                    $exists: true\n                }\n            }]\n        }]\n    });\n\n    if (!fcList) {\n        throw new Meteor.Error(404, 'No such fcList');\n    }\n\n    const hasUserRsvp = _.findWhere(fcList.rsvps, {\n        user: this.userId\n    });\n\n    if (!hasUserRsvp) {\n        // add new rsvp entry\n        Parties.update(fcListId, {\n            $push: {\n                rsvps: {\n                    rsvp,\n                    user: this.userId\n                }\n            }\n        });\n    } else {\n        // update rsvp entry\n        const userId = this.userId;\n        Parties.update({\n            _id: fcListId,\n            'rsvps.user': userId\n        }, {\n            $set: {\n                'rsvps.$.rsvp': rsvp\n            }\n        });\n    }\n}\n\nMeteor.methods({\n    invite,\n    rsvp\n});\n\n"]}